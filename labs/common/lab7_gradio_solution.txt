#!/usr/bin/env python3
"""
Lab 7: Gradio Web Interface for the Office Agent
═══════════════════════════════════════════════════════════════════════
Adds a professional web UI on top of the self-contained agent from Lab 6.

KEY CONCEPTS
------------
- gr.Blocks: Gradio's flexible layout system (rows, columns, components)
- gr.Chatbot: Built-in chat component with message history
- Event handlers: .click() and .submit() wire UI actions to Python functions
- gr.themes.Soft(): Pre-built professional theme

ARCHITECTURE
------------
  User types query → chat_handler() → rag_agent.run_agent() → response
  Response displayed in Chatbot component with full conversation history
"""

# ═══════════════════════════════════════════════════════════════════════
# IMPORTS
# ═══════════════════════════════════════════════════════════════════════

import gradio as gr

# ─────────────────────────────────────────────────────────────────────
# Agent Import — if the agent isn't available, the UI runs in demo mode
# ─────────────────────────────────────────────────────────────────────
try:
    from rag_agent import run_agent
    AGENT_AVAILABLE = True
except ImportError:
    AGENT_AVAILABLE = False
    print("Warning: rag_agent not available. Running in demo mode.")


# ╔══════════════════════════════════════════════════════════════════╗
# ║ 1.  Custom CSS for professional styling                         ║
# ╚══════════════════════════════════════════════════════════════════╝

CUSTOM_CSS = """
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

.gradio-container {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
}

.office-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin: 0.375rem 0;
    font-size: 0.9rem;
    color: #475569;
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
}
"""


# ╔══════════════════════════════════════════════════════════════════╗
# ║ 2.  Chat handler — bridges the UI to the agent                  ║
# ╚══════════════════════════════════════════════════════════════════╝

def chat_handler(message: str, history: list) -> tuple:
    """
    Process a user message through the agent and update chat history.

    Parameters
    ----------
    message : str
        The user's input text
    history : list
        Gradio Chatbot history (list of {"role": ..., "content": ...} dicts)

    Returns
    -------
    tuple of (history, "")
        Updated history and empty string to clear the input box
    """
    if not message.strip():
        return history, ""

    # Add user message to history
    history = history + [{"role": "user", "content": message}]

    if not AGENT_AVAILABLE:
        history = history + [{"role": "assistant",
                              "content": "[Demo Mode] Agent not available. "
                                         "Please ensure rag_agent.py is complete."}]
        return history, ""

    # Run the agent and get the response
    try:
        result = run_agent(message)
        history = history + [{"role": "assistant", "content": result}]
    except Exception as e:
        history = history + [{"role": "assistant",
                              "content": f"Error processing query: {e}"}]

    return history, ""


# ╔══════════════════════════════════════════════════════════════════╗
# ║ 3.  Gradio Interface Layout                                     ║
# ╚══════════════════════════════════════════════════════════════════╝

with gr.Blocks(
    title="AI Office Assistant",
) as demo:

    # ── Header ─────────────────────────────────────────────────────
    gr.HTML("""
    <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
                padding: 1.5rem 2rem;
                border-radius: 14px;
                color: white;
                margin-bottom: 1rem;">
        <h1 style="margin: 0; font-size: 1.8rem; font-weight: 700;">
            AI Office Assistant
        </h1>
        <p style="margin: 0.25rem 0 0 0; opacity: 0.9; font-size: 0.95rem;">
            Powered by RAG + Live Weather Data
        </p>
    </div>
    """)

    # ── Main layout: chat area (left) + sidebar (right) ────────────
    with gr.Row():
        # ── Chat column ────────────────────────────────────────────
        with gr.Column(scale=3):
            chatbot = gr.Chatbot(
                height=450,
            )

            msg = gr.Textbox(
                placeholder="e.g. 'Tell me about HQ' or 'Southern office info'",
                show_label=False,
                container=False,
            )

            with gr.Row():
                send_btn = gr.Button("Send", variant="primary", scale=3)
                clear_btn = gr.Button("Clear Chat", scale=1)

            gr.Markdown("**Try these queries:**")
            with gr.Row():
                ex1 = gr.Button("Tell me about HQ", size="sm", variant="secondary")
                ex2 = gr.Button("Southern office", size="sm", variant="secondary")
                ex3 = gr.Button("West Coast details", size="sm", variant="secondary")

        # ── Sidebar column ─────────────────────────────────────────
        with gr.Column(scale=1):
            gr.Markdown("### Company Offices")
            gr.HTML("""
            <div class="office-card"><strong>HQ</strong> — New York, NY<br>150 employees · $85.5M revenue</div>
            <div class="office-card"><strong>West Coast</strong> — San Francisco, CA<br>95 employees · $78.9M revenue</div>
            <div class="office-card"><strong>Southern</strong> — Austin, TX<br>80 employees · $52.3M revenue</div>
            <div class="office-card"><strong>Midwest</strong> — Chicago, IL<br>120 employees · $67.2M revenue</div>
            <div class="office-card"><strong>Southeast</strong> — Atlanta, GA<br>75 employees · $48.7M revenue</div>
            """)

            gr.Markdown("### How It Works")
            gr.Markdown(
                "1. **RAG Search** — Finds office data in vector DB\n"
                "2. **Geocoding** — Looks up city coordinates\n"
                "3. **Weather** — Fetches live weather data\n"
                "4. **Summary** — LLM composes a friendly answer"
            )

    # ╔══════════════════════════════════════════════════════════════╗
    # ║ 4.  Event handlers — wire UI actions to Python functions     ║
    # ╚══════════════════════════════════════════════════════════════╝

    # Send button and Enter key both trigger chat_handler
    send_btn.click(
        chat_handler,
        inputs=[msg, chatbot],
        outputs=[chatbot, msg],
    )
    msg.submit(
        chat_handler,
        inputs=[msg, chatbot],
        outputs=[chatbot, msg],
    )

    # Clear button resets the chat
    clear_btn.click(lambda: ([], ""), outputs=[chatbot, msg])

    # Example buttons populate the input box
    ex1.click(lambda: "Tell me about HQ", outputs=[msg])
    ex2.click(lambda: "Tell me about the Southern office", outputs=[msg])
    ex3.click(lambda: "Tell me about the West Coast office", outputs=[msg])

    # ── Footer ─────────────────────────────────────────────────────
    gr.HTML("""
    <div style="text-align: center; padding: 1rem; margin-top: 1rem;
                border-top: 1px solid #e2e8f0; color: #94a3b8; font-size: 0.8rem;">
        AI Office Assistant: Agents, RAG and Local Models
        · <a href="https://getskillsnow.com" target="_blank"
              style="color: #64748b; text-decoration: none;">
            &copy; 2026 Tech Skills Transformations
          </a>
    </div>
    """)


# ╔══════════════════════════════════════════════════════════════════╗
# ║ 5.  Main entry point                                            ║
# ╚══════════════════════════════════════════════════════════════════╝
if __name__ == "__main__":
    print("=" * 60)
    print("AI Office Assistant — Gradio Interface")
    print("=" * 60)
    print(f"Agent available: {AGENT_AVAILABLE}")
    print("Starting Gradio interface...")
    print("=" * 60)

    demo.launch(
        server_name="0.0.0.0",
        server_port=7860,
        share=True,
        css=CUSTOM_CSS,
        theme=gr.themes.Soft(),
    )

